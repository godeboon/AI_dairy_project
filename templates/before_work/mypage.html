<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê°ì„± ë‹¤ì´ì–´ë¦¬</title>
  <link rel="stylesheet" href="/static/mypage_css.css">
  <link rel="stylesheet" href="/static/chat.css">
</head>
<body>
  <!-- ë¡œê·¸ì¸ ì „ ë©”ì¸ í˜ì´ì§€ -->
  <header>
    <div class="header-left">
      <h1>ë‹¹ê³°ë‹¤, ë‹¹ì‹ ì˜ ê³µê°„ì„ ë‹´ë‹¤</h1>
    </div>
    <nav class="nav-links">
      <a href="#">í™ˆ</a>
      <a href="#">ì„œë¹„ìŠ¤ ì†Œê°œ</a>
      <a href="#">About</a>
      <a href="#">Contact</a>
    </nav>
    <div class="header-right">
      <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ -->
      <div id="guest-header">
        <button class="login-btn" onclick="window.location.href='/login'">ë¡œê·¸ì¸</button>
      </div>
      
      <!-- ë¡œê·¸ì¸ ìƒíƒœ -->
      <div id="user-header" style="display: none;">
        <div class="welcome-message" id="welcome-message"></div>
        <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <h2>ë‹¹ì‹ ì˜ ê°ì •ì„ ë‹´ì€ ê³µê°„, ì§€ê¸ˆ ì‹œì‘í•´ë³´ì„¸ìš”</h2>
      <p class="subtitle">AIì™€ í•¨ê»˜ ë‚˜ë¥¼ ëŒì•„ë³´ëŠ” ê°ì„± ë‹¤ì´ì–´ë¦¬ ì„œë¹„ìŠ¤</p>
      <button class="start-btn" onclick="openMySpace()">ë‚˜ì˜ ê³µê°„ ì…ì¥í•˜ê¸°</button>
    </section>

    <section class="features">
      <div class="feature-card">
        <div class="emoji">ğŸ““</div>
        <h3>ê°ì • ì¼ê¸°</h3>
        <p>GPTì™€ ëŒ€í™”í•˜ë©° ê°ì •ì„ ìì—°ìŠ¤ëŸ½ê²Œ ê¸°ë¡í•´ìš”.</p>
      </div>
      <div class="feature-card">
        <div class="emoji">ğŸ“Š</div>
        <h3>ê°ì • ê·¸ë˜í”„</h3>
        <p>ì‹œê°„ íë¦„ì— ë”°ë¼ ê°ì •ì˜ ë³€í™”ê°€ ì‹œê°í™”ë¼ìš”.</p>
      </div>
      <div class="feature-card">
        <div class="emoji">ğŸŒŒ</div>
        <h3>ê°ì„± ê³µê°„</h3>
        <p>í•˜ëŠ˜, ë°©, ì •ì› ë“± ë‚˜ë§Œì˜ ê³µê°„ì„ ê¾¸ë©°ìš”.</p>
      </div>
    </section>
  </main>

  <footer>
    <p>Â© 2025 ê°ì„± ë‹¤ì´ì–´ë¦¬ | ë‹¹ì‹ ì˜ ê°ì •ì„ ë‹´ë‹¤.</p>
  </footer>

  <!-- ë‚˜ì˜ ê³µê°„ íŒì—…ì°½ -->
  <div id="mySpaceModal" class="modal">
    <div class="modal-content">
      <!-- ë‹«ê¸° ë²„íŠ¼ -->
      <div class="close-btn" onclick="closeMySpace()">Ã—</div>
      
      <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
      <div class="modal-main">
        <!-- ìƒë‹¨ ë©”ì¸ íƒ­ -->
        <div class="main-tabs">
          <button class="main-tab active" onclick="switchMainTab('chat')">ëŒ€í™”í•˜ê¸°</button>
          <button class="main-tab" onclick="switchMainTab('study')">ì„œì¬</button>
          <button class="main-tab" onclick="switchMainTab('constellation')">ë³„ìë¦¬</button>
          <button class="main-tab" onclick="switchMainTab('garden')">í…ƒë°­</button>
        </div>
        
        <!-- ì½˜í…ì¸  ì˜ì—­ -->
        <div class="content-area">
          <!-- ì™¼ìª½ ì„œë¸Œ íƒ­ -->
          <div class="left-sidebar">
            <div class="sub-tabs" id="subTabs">
              <!-- ì„œë¸Œ íƒ­ë“¤ì€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
          </div>
          
          <!-- ë©”ì¸ ì½˜í…ì¸  -->
          <div class="main-content">
            <!-- ëŒ€í™”í•˜ê¸° ì˜ì—­ -->
            <div id="chat-content" class="content-section active">
              <div id="chat-container">
                <!-- chat.html ë‚´ìš©ì´ ì—¬ê¸°ì— ë¡œë“œë¨ -->
              </div>
            </div>
            
            <!-- ì„œì¬ ì˜ì—­ -->
            <div id="study-content" class="content-section">
              <div class="study-top">
                <!-- ì„œì¬ ê³µê°„ (ìƒë‹¨) -->
                <div class="study-space">
                  <img src="/static/ì„œì¬_2d.jpg" alt="ë‚˜ì˜ ì„œì¬" class="study-image">
                </div>
              </div>
              <div class="study-bottom">
                <!-- í€˜ìŠ¤íŠ¸ ì°½ (í•˜ë‹¨) -->
                <div class="quest-window">
                  <h3>ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸</h3>
                  <!-- í€˜ìŠ¤íŠ¸ ë‚´ìš© -->
                </div>
              </div>
            </div>
            
            <!-- ë³„ìë¦¬ ì˜ì—­ -->
            <div id="constellation-content" class="content-section">
              <h3>ë‚˜ì˜ ë³„ìë¦¬</h3>
              <!-- ë³„ìë¦¬ ë‚´ìš© -->
            </div>
            
            <!-- í…ƒë°­ ì˜ì—­ -->
            <div id="garden-content" class="content-section">
              <h3>ë‚˜ì˜ í…ƒë°­</h3>
              <!-- í…ƒë°­ ë‚´ìš© -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° í—¤ë” ë³€ê²½
    function checkLoginStatus() {
      const token = localStorage.getItem("access_token");
      const nickname = localStorage.getItem("nickname");
      
      if (token && nickname) {
        // ë¡œê·¸ì¸ ìƒíƒœ: í—¤ë” ë³€ê²½
        document.getElementById('guest-header').style.display = 'none';
        document.getElementById('user-header').style.display = 'block';
        document.getElementById('welcome-message').textContent = `${nickname}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤`;
      } else {
        // ë¹„ë¡œê·¸ì¸ ìƒíƒœ: ê¸°ì¡´ í—¤ë” ìœ ì§€
        document.getElementById('guest-header').style.display = 'block';
        document.getElementById('user-header').style.display = 'none';
      }
    }

    // ë¡œê·¸ì•„ì›ƒ ìš”ì²­
    async function logout() {
      const user_id = localStorage.getItem("user_id");
      
      try {
        // ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­
        if (user_id) {
          await fetch("/logout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: parseInt(user_id) })
          });
        }
        
        // localStorage ì •ë¦¬
        localStorage.clear();
        
        // í—¤ë” ë³€ê²½
        checkLoginStatus();
        
      } catch (error) {
        console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
        // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ localStorageëŠ” ì •ë¦¬
        localStorage.clear();
        checkLoginStatus();
      }
    }

    // ë‚˜ì˜ ê³µê°„ íŒì—…ì°½ ì—´ê¸°
    async function openMySpace() {
      const token = localStorage.getItem("access_token");
      if (token) {
        // ì±„íŒ… ì´ë²¤íŠ¸ ë¡œê·¸
        await fetch("/chat/open", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          }
        });
        // íŒì—…ì°½ ì—´ê¸°
        document.getElementById('mySpaceModal').style.display = 'flex';
        // ë‚´ë¶€ ìƒíƒœ ì´ˆê¸°í™”
        document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
        document.getElementById('chat-container').innerHTML = '';
        updateSubTabs(null); // ì•Œë¦¼ë§Œ ë³´ì´ê²Œ
      } else {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login";
      }
    }

    // íŒì—…ì°½ ë‹«ê¸°
    function closeMySpace() {
      document.getElementById('mySpaceModal').style.display = 'none';
      // ë‚´ë¶€ ìƒíƒœ ì´ˆê¸°í™”
      document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      document.getElementById('chat-container').innerHTML = '';
      updateSubTabs(null); // ì•Œë¦¼ë§Œ ë³´ì´ê²Œ
    }

    // ë©”ì¸ íƒ­ ì „í™˜
    function switchMainTab(tabName, event) {
      // ëª¨ë“  ë©”ì¸ íƒ­ ë¹„í™œì„±í™”
      document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
      // ëª¨ë“  ì½˜í…ì¸  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      // ì„ íƒëœ íƒ­ í™œì„±í™”
      if (event && event.target) {
        event.target.classList.add('active');
      } else {
        // ì§ì ‘ í˜¸ì¶œ ì‹œ ì²« ë²ˆì§¸ í•´ë‹¹ íƒ­ ë²„íŠ¼ì„ ì°¾ì•„ì„œ active
        const btn = document.querySelector(`.main-tab[onclick*="${tabName}"]`);
        if (btn) btn.classList.add('active');
      }
      // í•´ë‹¹ ì½˜í…ì¸  í‘œì‹œ
      document.getElementById(`${tabName}-content`).classList.add('active');
      // ì„œë¸Œ íƒ­ ì—…ë°ì´íŠ¸
      updateSubTabs(tabName);
      // ëŒ€í™”í•˜ê¸° íƒ­ì´ë©´ chat.html ë¡œë“œ
      if (tabName === 'chat') loadChatContent();
    }

    // chat.html ë‚´ìš© ë¡œë“œ
    async function loadChatContent() {
      const chatContainer = document.getElementById('chat-container');
      try {
        const response = await fetch('/chatroom');
        const chatHTML = await response.text();
        // HTMLì—ì„œ body ë‚´ìš©ë§Œ ì¶”ì¶œ
        const parser = new DOMParser();
        const doc = parser.parseFromString(chatHTML, 'text/html');
        const chatBody = doc.querySelector('body');
        // ê¸°ì¡´ ë‚´ìš© ì œê±°í•˜ê³  ìƒˆë¡œìš´ ë‚´ìš© ì‚½ì…
        chatContainer.innerHTML = chatBody.innerHTML;
        // chat.js ë™ì  ë¡œë“œ
        if (!window._chatJsLoaded) {
          const script = document.createElement('script');
          script.src = '/static/chat.js';
          script.onload = function() {
            window._chatJsLoaded = true;
            if (window.initChatUI) window.initChatUI();
          };
          document.body.appendChild(script);
        } else {
          if (window.initChatUI) window.initChatUI();
        }
      } catch (error) {
        console.error('ì±„íŒ… ë‚´ìš© ë¡œë“œ ì˜¤ë¥˜:', error);
        chatContainer.innerHTML = '<p>ì±„íŒ…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    // ì„œë¸Œ íƒ­ ì—…ë°ì´íŠ¸
    function updateSubTabs(mainTab) {
      const subTabsContainer = document.getElementById('subTabs');
      subTabsContainer.innerHTML = '';
      // ì•„ë¬´ íƒ­ë„ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°(ì´ˆê¸°í™”)
      if (!mainTab) {
        subTabsContainer.innerHTML = `<div class="sub-tab active">ì•Œë¦¼</div>`;
        return;
      }
      switch(mainTab) {
        case 'chat':
          subTabsContainer.innerHTML = `
            <div class="sub-tab active">ì•Œë¦¼</div>
            <div class="sub-tab" onclick="switchSubTab('chat')">ëŒ€í™”í•˜ê¸°</div>
            <div class="sub-tab" onclick="switchSubTab('chat-list')">ì±„íŒ…ëª©ë¡</div>
          `;
          break;
        case 'study':
          subTabsContainer.innerHTML = `
            <div class="sub-tab active">ì•Œë¦¼</div>
            <div class="sub-tab" onclick="switchSubTab('diary')">ì¼ê¸° ìƒì„±í•˜ê¸°</div>
            <div class="sub-tab" onclick="switchSubTab('graph')">ê°ì„±ê·¸ë˜í”„</div>
            <div class="sub-tab" onclick="switchSubTab('keyword')">í•˜ë£¨ í‚¤ì›Œë“œ</div>
            <div class="sub-tab" onclick="switchSubTab('music')">ìŒì•…ì¶”ì²œ</div>
          `;
          break;
        case 'constellation':
          subTabsContainer.innerHTML = `
            <div class="sub-tab active">ì•Œë¦¼</div>
            <div class="sub-tab" onclick="switchSubTab('constellation-detail')">ë³„ìë¦¬ ìƒì„¸</div>
          `;
          break;
        case 'garden':
          subTabsContainer.innerHTML = `
            <div class="sub-tab active">ì•Œë¦¼</div>
            <div class="sub-tab" onclick="switchSubTab('plant-seed')">ì”¨ì•— ì‹¬ê¸°</div>
            <div class="sub-tab" onclick="switchSubTab('grow-seed')">ì”¨ì•— ê°€ê¾¸ê¸°</div>
          `;
          break;
      }
    }

    // ì„œë¸Œ íƒ­ ì „í™˜
    function switchSubTab(subTabName) {
      // ëª¨ë“  ì„œë¸Œ íƒ­ ë¹„í™œì„±í™”
      document.querySelectorAll('.sub-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // ì„ íƒëœ ì„œë¸Œ íƒ­ í™œì„±í™”
      event.target.classList.add('active');
      
      // ì„œë¸Œ íƒ­ë³„ ì½˜í…ì¸  ì²˜ë¦¬
      console.log(`ì„œë¸Œ íƒ­ ì „í™˜: ${subTabName}`);
      
      if (subTabName === 'chat-list') {
        loadChatListContent();
      } else if (subTabName === 'chat') {
        loadChatContent();
      }
    }
    
    // ì±„íŒ… ëª©ë¡ ì½˜í…ì¸  ë¡œë“œ
    async function loadChatListContent() {
      const chatContainer = document.getElementById('chat-container');
      try {
        const response = await fetch('/components/chatting/sub_chat_list.html');
        const chatListHTML = await response.text();
        chatContainer.innerHTML = chatListHTML;
        
        // sub_chat_list.css ë¡œë“œ
        if (!document.querySelector('link[href*="sub_chat_list.css"]')) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = '/static/css/components/chatting/sub_chat_list.css';
          document.head.appendChild(link);
        }
        
        // sub_chat_list.js ë¡œë“œ
        if (!window._chatListJsLoaded) {
          const script = document.createElement('script');
          script.src = '/static/js/components/chatting/sub_chat_list.js';
          script.onload = function() {
            window._chatListJsLoaded = true;
          };
          document.body.appendChild(script);
        }
      } catch (error) {
        console.error('ì±„íŒ… ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        chatContainer.innerHTML = '<p>ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    window.onload = function () {
      checkLoginStatus();
    };

    // ESC í‚¤ë¡œ íŒì—…ì°½ ë‹«ê¸°
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeMySpace();
      }
    });
  </script>
</body>
</html>
